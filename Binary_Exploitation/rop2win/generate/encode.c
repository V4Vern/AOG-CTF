#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "base64.h"
#include "rc4.h"
#include "keys.h"

int main(int argc, char** argv) {
	int result;

	// Extract flag from flag.txt
	char flag[64];

	printf("%s\n", "[+] Extracting flag...");

	FILE *f = fopen("flag.txt","r");
	if (f == NULL) {
		printf("[-] Flag File is Missing.\n");
		exit(0);
	}
	
	fgets(flag, sizeof(flag),f);

	fclose(f);

	// Part 1: base64 encode flag
	char base64_flag[64];
	void* flag2 = (void*)flag;

	printf("%s\n", "[+] Base64-encoding flag...");

	result = base64encode(flag2, strlen(flag), base64_flag, sizeof(base64_flag));

	

	if (result != 0) {
		printf("%s\n", "[-] Error occured while base64-ing");
		exit(1);
	}

	// Part 2: RC4 cipher
	unsigned char *RC4_ciphertext = malloc(sizeof(int) * strlen(base64_flag));

	printf("%s\n", "[+] RC4 ciphering flag...");

	result = RC4(RC4_key, base64_flag, RC4_ciphertext);

	// for(size_t i = 0, len = strlen(base64_flag); i < len; i++)
	// 	printf("%02hhX", ciphertext[i]);

	// Part 3: Xor

	printf("%s\n", "[+] Xor-ing flag...");
	
	unsigned char *xor_ciphertext = malloc(sizeof(int) * strlen(base64_flag));

	for (size_t i = 0, len = strlen(base64_flag); i < len; i++)
		xor_ciphertext[i] = RC4_ciphertext[i] ^ xor_key[i];


	printf("%s\n", "[+] encrypted flag created! Saving it as flag.enc");
	FILE *save = fopen("flag.enc", "wb");

	for (size_t i = 0, len = strlen(base64_flag); i < len; i++)
		putc(xor_ciphertext[i], save);

	// for(size_t i = 0, len = strlen(base64_flag); i < len; i++)
	// 	printf("%02hhX", xor_ciphertext[i]);

	free(RC4_ciphertext);
	free(xor_ciphertext);
	fclose(save);
}