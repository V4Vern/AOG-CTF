#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "base64.h"
#include "rc4.h"
#include "keys.h"

void decrypt_flag(){
	// Read file
	unsigned char ciphertext[64];
	int result;

	printf("%s\n", "[+] Reading encrypted file...");

	FILE *f = fopen("flag.enc", "rb");
	if (f == NULL) {
		printf("[-] Enc File is Missing.\n");
		exit(0);
	}

	fgets(ciphertext, sizeof(ciphertext), f);

	// Part 1: Xor
	printf("%s\n", "[+] Xor ciphering encrypted...");
	for (size_t i = 0, len = strlen(ciphertext); i < len; i++)
		ciphertext[i] = ciphertext[i] ^ xor_key[i];

	// Part 2: RC4
	unsigned char rc4_out[64];

	printf("%s\n", "[+] RC4 ciphering encrypted...");

	result = RC4(RC4_key, ciphertext, rc4_out);

	// Part 3: Base64 Decode

	printf("%s\n", "[+] Base64-decoding encrypted...");

	char *base64_in = (char*) rc4_out;
	unsigned char flag[64];
	size_t flag_len = sizeof(flag);

	result = base64decode(base64_in, strlen(base64_in), flag, &flag_len);

	printf("%s\n", flag);

}

int main(int argc, char** argv) {
	decrypt_flag();
}