#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "base64.h"
#include "rc4.h"
#include "keys.h"

unsigned char ciphertext[64];
unsigned char rc4_out[64];
unsigned char flag[64];
int result;

int check1 = 0;
int check2 = 0;

void function_one(long arg1, long arg2) {
	if (arg1 == 0xdeadbeef && arg2 == 0xcafebabe){
		// Read file

		FILE *f = fopen("flag.enc", "rb");
		if (f == NULL) {
			printf("[-] Enc File is Missing.\n");
			exit(0);
		}

		fgets(ciphertext, sizeof(ciphertext), f);

		// Part 1: Xor
		printf("%s\n", "[+] Part 1: OK! Xor-ing encrypted flag...");
		for (size_t i = 0, len = strlen(ciphertext); i < len; i++)
			ciphertext[i] = ciphertext[i] ^ xor_key[i];

		check1 = 1;
	} else {
		printf("[-] Function 1 failed\n");
	}
}

void function_two(long arg1, long arg2) {
	if (arg1 == 0xdeadbeef && arg2 == 0xcafebabe && check1 == 1){
		// Part 2: RC4
		printf("%s\n", "[+] Part 2: OK! RC4-ciphering encrypted flag...");
		RC4(RC4_key, ciphertext, rc4_out);
		check2 = 1;
	} else {
		printf("[-] Function 2 failed\n");
	}
}

void function_three(long arg1, long arg2) {
	if (arg1 == 0xdeadbeef && arg2 == 0xcafebabe && check1 == 1 && check2 == 1){
		// Part 3: Base64 Decode

		printf("%s\n", "[+] Part 3: OK! Base64-decoding flag...");
		
		char *base64_in = (char*) rc4_out;
		size_t flag_len = sizeof(flag);

		result = base64decode(base64_in, strlen(base64_in), flag, &flag_len);

		printf("%s\n", flag);
	} else {
		printf("[-] Function 3 failed\n");
	}
}

void vuln(){
	char buffer[64] = {0x00};
	printf("%s\n", "Hey man how's it going! Wanna ROP?");

	gets(buffer);
}

int main(int argc, char** argv) {
	setvbuf(stdin,NULL,2,0);
	setvbuf(stdout,NULL,2,0);
	setvbuf(stderr,NULL,2,0);

	vuln();
}