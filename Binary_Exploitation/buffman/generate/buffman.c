#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <signal.h>

#define FLAGSIZE_MAX 64

char flag[FLAGSIZE_MAX];

void sigsegv_handler(int sig) {
  // Set up flag
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("Flag File is Missing.\n");
    exit(0);
  }
  fgets(flag,FLAGSIZE_MAX,f);
  fprintf(stderr, "%s\n", flag);
  fflush(stderr);
  exit(1);
}

void vulnerable(){
  char buf[64] = {0x00};

  printf("%s\n","All you got to do is overwrite my return address!");
  printf("%s %p\n", "Location of buf:", buf);
  printf("%s %p\n", "Value of return address:", __builtin_return_address(0));
  
  gets(buf);

  printf("%s %p\n", "Value of return address:", __builtin_return_address(0));
  printf("%s\n", "Are you the buffman we all need?");  
}

int main(int argc, char **argv){
  signal(SIGSEGV, sigsegv_handler);
  setvbuf(stdout, NULL, _IONBF, 0);

  vulnerable();
  return 0;
}